function Manifest(){this.start_scene=void 0,this.size={x:128,y:128},this.background="white",this.scale=1,this.frame_rate=60,this.assets=[],this.maps=[],this.fonts=[],this.boxes=[],this.set={start_screen:f=>{this.start_scene=f},background:f=>{this.background=f},scale:f=>{this.scale=f},size:(f,g)=>{this.size={x:f,y:g}},frame_rate:f=>{this.frame_rate=f}},this.add={image:(f,g)=>{this.assets.push({type:"img",name:f,path:g})},sound:(f,g)=>{this.assets.push({type:"audio",name:f,path:g})},map:(f,g)=>{this.assets.push({type:"map",name:f,path:g})}},this.create={font:(f,g,h,j)=>{this.fonts.push({name:f,image:g,size:{x:h,y:j}})},box:(f,g,h)=>{this.boxes.push({name:f,image:g,resolution:h})}}}function createManifest(){return new Manifest}class Box{constructor(f,g){this.world=f,this.ctx=f.ctx,this.c_ctx=f.c_ctx,this.box_data=g,this.resolution=g.resolution,this.image=f.assets.image[g.image].image}display(f,g,h,j,l){h=Math.max(2*this.resolution,h),j=Math.max(2*this.resolution,j),this.ctx.fillStyle=l||this.world.background_color,this.ctx.fillRect(f+1,g+1,h-2,j-2),this.ctx.lineWidth=2;for(let o=0;4>o;o++){let p=f+Math.floor(o%2)*(h-this.resolution),q=g+Math.floor(o/2)*(j-this.resolution),r=Math.floor(o%2)*(2*this.resolution),s=Math.floor(o/2)*(2*this.resolution);this.ctx.drawImage(this.image,r,s,this.resolution,this.resolution,p,q,this.resolution,this.resolution)}let n=3*this.resolution;this.ctx.drawImage(this.image,8,0,this.resolution,this.resolution,f+8,g,this.resolution+h-n,this.resolution),this.ctx.drawImage(this.image,8,16,this.resolution,this.resolution,f+8,g+j-this.resolution,this.resolution+h-n,this.resolution),this.ctx.drawImage(this.image,0,8,this.resolution,this.resolution,f,g+8,this.resolution,this.resolution+j-n),this.ctx.drawImage(this.image,16,8,this.resolution,this.resolution,f+h-this.resolution,g+this.resolution,this.resolution,this.resolution+j-n)}}let Util={};Util.timeStamp=function(){return window.performance.now()},Util.between=function(f,g,h){return 0>(f-g)*(f-h)},Util.random=function(f,g){return f+Math.random()*(g-f)},Util.randomInt=function(f,g){return Math.round(this.random(f,g))},Util.map=function(f,g,h,j,l){return(f-g)/(h-g)*(l-j)+j},Util.lerp=function(f,g,h){return f+(g-f)*h},Util.clamp=function(f,g,h){return Math.max(g,Math.min(h,f))},Util.array2D=function(f,g){for(var h=[],j=0;j<f.length;j+=g)h.push(f.slice(j,j+g));return h},Tween={},Tween.linear=function(f,g,h,j){return h*f/j+g},Tween.easeInOutQuad=function(f,g,h,j){return(f/=j/2,1>f)?h/2*f*f+g:(f--,-h/2*(f*(f-2)-1)+g)},Tween.easeInOutExpo=function(f,g,h,j){return(f/=j/2,1>f)?h/2*Math.pow(2,10*(f-1))+g:(f--,h/2*(-Math.pow(2,-10*f)+2)+g)};let Scene=class{constructor(g){this.name=g,this.loop=!0,this.init_once=!1}giveWorld(g){this.world=g,this.ctx=g.ctx,this.camera=new Camera(this,0,0)}keyDown(){}keyUp(){}init(){}render(){}};class Vector{constructor(f,g){this.x=f||0,this.y=g||0}set(f,g){this.x=f,this.y=g}add(f){this.x+=f.x,this.y+=f.y}sub(f){this.x-=f.x,this.y-=f.y}mult(f){this.x*=f,this.y*=f}div(f){this.x/=f,this.y/=f}dot(f){return f.x*this.x+f.y*this.y}limit(f){this.mag()>f&&this.setMag(f)}mag(){return Math.hypot(this.x,this.y)}setMag(f){0<this.mag()?this.normalize():(this.x=1,this.y=0),this.mult(f)}normalize(){let f=this.mag();0<f&&(this.x/=f,this.y/=f)}heading(){return Math.atan2(this.x,this.y)}setHeading(f){let g=this.mag();this.x=Math.cos(f)*g,this.y=Math.sin(f)*g}dist(f){return new Vector(this.x-f.x,this.y-f.y).mag()}angleBetween(f){return Math.atan2(f.y-this.y,f.x-this.x)}copy(){return new Vector(this.x,this.y)}fromAngle(f){let g=Math.cos(f),h=Math.sin(f);return new Vector(g,h)}}class Entity{constructor(f,g,h){this.scene=f,this.world=f.world,this.ctx=this.world.ctx,this.body=new Body(this,g,h)}setSprite(f){this.sprite=new Sprite(this,f)}display(){(this.sprite===void 0||!0===this.world.debug)&&(this.ctx.lineWidth=1,this.ctx.strokeStyle="#000",this.ctx.strokeRect(this.body.position.x-0.5,this.body.position.y-0.5,this.body.size.x,this.body.size.y)),this.sprite!==void 0&&this.sprite.display(this.body.position.x,this.body.position.y)}}class Sprite{constructor(f,g){this.entity=f,this.world=this.entity.world,this.tile_size=this.world.tile_size,this.ctx=this.world.ctx,this.image=this.world.assets.image[g.image].image,this.size=g.size,this.current_frame=0,this.animations={},this.current_animation=void 0,this.width=this.image.width/this.size.x,this.height=this.image.height/this.size.y,this.tick=0,this.speed=0.2,this.offset={x:0,y:0},this.setOffset(0.5,0.5),this.addAnimation("none",[0])}setOffset(f,g){this.offset.x=f,this.offset.y=g}addAnimation(f,g){this.animations[f]=g,this.current_animation=f}animate(f){this.current_animation=f,1>this.tick?this.tick+=this.speed:(this.tick=0,this.current_frame<this.animations[f].length-1?this.current_frame+=1:this.current_frame=0)}display(f,g){this.ctx.drawImage(this.image,Math.floor(this.animations[this.current_animation][this.current_frame]%this.width)*this.size.x,Math.floor(this.animations[this.current_animation][this.current_frame]/this.width)*this.size.y,this.size.x,this.size.y,f-this.size.x/2+this.offset.x*this.entity.body.size.x,g-this.size.y/2+this.offset.y*this.entity.body.size.y,this.size.x,this.size.y)}}class Body{constructor(f,g,h){this.world=f.world,this.step=this.world.FPS.step,this.position=new Vector(g,h),this.next_position=new Vector(g,h),this.velocity=new Vector(0,0),this.stepped_velocity=new Vector(0,0),this.acceleration=new Vector(0,0),this.drag=0.98,this.bounciness=0.2,this.size={x:this.world.tile_size,y:this.world.tile_size},this.half={x:this.size.x/2,y:this.size.y/2},this.collision={left:!1,top:!1,right:!1,bottom:!1}}setSize(f,g){this.size.x=f,this.size.y=g,this.half={x:this.size.x/2,y:this.size.y/2}}updateVelocity(){this.velocity.add(this.acceleration),this.velocity.mult(this.drag),this.stepped_velocity=this.velocity.copy(),this.stepped_velocity.mult(this.step),this.next_position=this.position.copy(),this.next_position.add(this.stepped_velocity),this.acceleration.mult(0)}updatePosition(){this.position.add(this.stepped_velocity)}integration(){this.updateVelocity(),this.updatePosition()}applyForce(f){this.acceleration.add(f)}getTileCollisionData(f,g){let h={x:Math.floor(f/this.world.tile_size),y:Math.floor(g/this.world.tile_size)},j=this.world.getTile(1,h.x,h.y);if(this.world.terrain.tileset.tileproperties[j]!==void 0&&!0===this.world.terrain.tileset.tileproperties[j].collision){let l=[{x:h.x-1,y:h.y},{x:h.x+1,y:h.y},{x:h.x,y:h.y-1},{x:h.x,y:h.y+1}].map(m=>{let n=this.world.getTile(1,m.x,m.y);return void 0!==this.world.terrain.tileset.tileproperties[n]&&!0===this.world.terrain.tileset.tileproperties[n].collision});return{position:h,neighbors:l}}return!1}mapCollision(){let f=this.position.x+this.stepped_velocity.x,g=this.position.y+this.stepped_velocity.y,h=this.getTileCollisionData(f,g),j=this.getTileCollisionData(f+this.size.x,g),l=this.getTileCollisionData(f,g+this.size.y),m=this.getTileCollisionData(f+this.size.x,g+this.size.y);this.collision.left=!1,this.collision.top=!1,this.collision.right=!1,this.collision.bottom=!1,h&&this.AABB(h),j&&this.AABB(j),l&&this.AABB(l),m&&this.AABB(m)}AABB(f){f.position.x*=this.world.tile_size,f.position.y*=this.world.tile_size;let g=this.world.tile_size/2,h=Math.abs(this.position.x+this.half.x-(f.position.x+g)),j=Math.abs(this.position.y+this.half.y-(f.position.y+g)),l=h-this.half.x-g,m=j-this.half.y-g;if(0>l||0>m){if(l==m&&(m=-1),0>l&&l>m)if(this.position.x>f.position.x){if(f.neighbors[1])return!1;this.position.x-=l,this.velocity.x*=-this.bounciness,this.collision.left=!0}else{if(f.neighbors[0])return!1;this.position.x+=l,this.velocity.x*=-this.bounciness,this.collision.right=!0}if(0>m&&m>l)if(this.position.y>f.position.y){if(f.neighbors[3])return!1;this.position.y-=m,this.velocity.y*=-this.bounciness,this.collision.top=!0}else{if(f.neighbors[2])return!1;this.position.y+=m,this.velocity.y*=-this.bounciness,this.collision.bottom=!0}}}}class Camera extends Entity{constructor(f,g,h){super(f,g,h),this.target={position:new Vector(this.world.W/2,this.world.H/2),size:{x:0,y:0}},this.boundless=!0,this.bounds={x:this.world.W,y:this.world.H},this.angle=0}setBounds(f,g){this.bounds.x=f-this.world.W,this.bounds.y=g-this.world.H}setTarget(f){this.target=f,this.target={position:f.body.position,size:f.sprite==void 0?f.body.size:f.sprite.size}}checkBounds(){return!this.boundless&&void(0>this.body.position.x&&(this.body.position.x=0),0>this.body.position.y&&(this.body.position.y=0),this.body.position.x>this.bounds.x&&(this.body.position.x=this.bounds.x),this.body.position.y>this.bounds.y&&(this.body.position.y=this.bounds.y))}update(){this.body.position.x=this.target.position.x+this.target.size.x/2-this.world.W/2,this.body.position.y=this.target.position.y+this.target.size.x/2-this.world.H/2,this.checkBounds(),this.world.ctx.translate(this.world.W/2,this.world.H/2),this.world.ctx.rotate(this.angle),this.world.ctx.translate(-this.body.position.x-this.world.W/2,-this.body.position.y-this.world.H/2)}}let Diorama=class{constructor(g){this.parameters=g,this.debug=!1,this.background_color=g.background||"#000",this.initCanvas(this.parameters),this.counter=0,this.toLoad=this.parameters.assets.length,this.assets={image:{},audio:{}},this.limit_input=!1,this.keys={},this.scenes={},this.start_screen=g.start_screen||void 0,this.current_scene="",this.currentFont=void 0,this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ?!:',.()<>[]",this.fonts={},this.tile_size=16,this.maps={},this.boxes={},this.FPS={now:0,delta:0,last:Util.timeStamp(),step:1/(this.parameters.frame_rate||60)},this.requestChange={value:!1,action:""},this.main_loop=void 0,this.full=!1,this.audio_muted=!1}ready(){this.loadAssets(this.parameters.assets)}initCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.W=this.canvas.width=this.parameters.size.x||256,this.H=this.canvas.height=this.parameters.size.y||256,this.scale=this.parameters.scale||1,this.full=!1,this.ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("crisp"),document.body.appendChild(this.canvas),this.setScale()}loader(){this.clear("#222"),this.counter+=1;let g=20,h=this.W-2*g,j=g,l=this.H-2*g;this.ctx.fillStyle="#111",this.ctx.fillRect(j,l,h,20),this.ctx.fillStyle="#333",this.ctx.fillRect(j,l,this.counter*h/this.toLoad,20),this.ctx.strokeStyle="#000",this.ctx.lineWidth=4,this.ctx.strokeRect(j,l,h,20),this.counter===this.toLoad&&this.launch()}loadAssets(g){g===void 0&&console.log("Nothing to load"),g.map(h=>this.checkAssets(h))}checkAssets(g){let h=g;switch(g.type){case"img":let j=new Image;j.onload=()=>{this.loader()},j.onerror=()=>{console.log("can't load Image: "+g.name)},j.src=g.path,h.image=j,this.assets.image[g.name]=h;break;case"audio":let l=new Audio(g.path);l.addEventListener("canplaythrough",this.loader()),l.onerror=()=>{console.log("can't load audio: "+g.name)},h.audio=l,this.assets.audio[g.name]=h;break;case"map":fetch(g.path).then(m=>{return 200===m.status?void m.json().then(n=>{this.maps[g.name]=n,this.loader()}):void console.log("Looks like there was a problem. Status Code: "+m.status)}).catch(function(){console.log("can't load map: "+g.name)});break;case void 0:console.log(g.name," doesn't have any type");break;default:console.log(g.name," has a none known type");}}launch(){this.eventSetup(),this.initBoxes(this.parameters.boxes),this.initFonts(this.parameters.fonts),this.startScene(this.start_screen)}initBoxes(g){return void 0!==g&&void g.map(h=>{this.boxes[h.name]=new Box(this,h)})}drawBox(g,h,j,l,m,n){this.boxes[g].display(h,j,l,m,n)}setFont(g){this.currentFont=g}initFonts(g){return void 0===g&&0<g.length?!1:void(g.map(h=>{return void 0===this.assets.image[h.image]?(console.log("can't load font, "+h.image+" doesn't exist"),!1):void(h.image=this.assets.image[h.image].image,this.fonts[h.name]=h)}),this.currentFont=Object.keys(this.fonts)[0])}write(g,h,j,l,m){if(void 0===this.currentFont)return console.log("No bitmap_font"),!1;if("string"==typeof l){switch(l){case"center":h-=g.length*this.fonts[this.currentFont].size.x/2;break;case"right":h-=g.length*this.fonts[this.currentFont].size.x;break;default:}this.writeLine(g,h,j,m||0)}else this.writeParagraph(g,h,j,l,m||0)}writeParagraph(g,h,j,l,m){let n=0,o=this.fonts[this.currentFont].size.y+5,p=this.fonts[this.currentFont].size.x,q=g.split(" "),r="";for(let s=0;s<q.length;s++){r+=q[s]+" ";let u=0,w=q[s+1],z=r.length*p;w?u=w.length*p:0,z+u>l?(this.writeLine(r,h,j+n,m),n+=o,r=""):this.writeLine(r,h,j+n,m)}}writeLine(g,h,j,l){let m=this.fonts[this.currentFont].size.x,n=this.fonts[this.currentFont].size.y,o=this.fonts[this.currentFont].image;for(let p=0;p<g.length;p++){let q=this.alphabet.indexOf(g.charAt(p)),s=h+p*m;this.ctx.drawImage(o,m*q,l*n,m,n,s,j,m,n)}}eventSetup(){document.addEventListener("keydown",g=>this.keyDown(g),!1),document.addEventListener("keyup",g=>this.keyUp(g),!1)}keyDown(g){this.limit_input&&g.preventDefault(),this.keys[g.key.toLowerCase()]=!0,this.current_scene.keyDown(g)}keyUp(g){this.keys[g.key.toLowerCase()]=!1,this.current_scene.keyDown(g)}startScene(g){return 0==Object.keys(game.scenes).length?(console.warn("Sorry, Your project doesn't have any scenes"),!1):(void 0==g&&(g=Object.keys(game.scenes)[0]),void 0===this.scenes[g]?(console.warn("Sorry, the scene named '"+g+"' doesn't exist"),!1):void 0===this.main_loop?void(this.requestChange.value=!1,this.requestChange.action="",this.FPS.last=Util.timeStamp(),this.current_scene=this.scenes[g],this.initScene(),!0===this.current_scene.loop?this.gameLoop():this.mainRender()):(this.requestChange.value=!0,this.requestChange.action=g,!1))}initScene(){return!this.current_scene.init_once&&void this.current_scene.init()}addScene(g){g.giveWorld(this),this.scenes[g.name]=g}mainRender(){this.clear(),this.ctx.save(),this.current_scene.camera.update(),this.current_scene.render(),this.ctx.restore()}loopCheck(){!1===this.requestChange.value?this.main_loop=requestAnimationFrame(()=>this.gameLoop()):(cancelAnimationFrame(this.main_loop),this.main_loop=void 0,this.startScene(this.requestChange.action))}gameLoop(){for(this.FPS.now=Util.timeStamp(),this.FPS.delta+=Math.min(1,(this.FPS.now-this.FPS.last)/1e3);this.FPS.delta>this.FPS.step;)this.FPS.delta-=this.FPS.step,this.mainRender();this.FPS.last=this.FPS.now,this.loopCheck()}soundLevel(g){for(let[h,j]of Object.entries(this.assets.audio))j.audio.volume=g}mute(){this.audio_muted=!this.audio_muted;for(let[g,h]of Object.entries(this.assets.audio))h.audio.muted=this.audio_muted}clear(g){this.ctx.fillStyle=g||this.background_color,this.ctx.fillRect(0,0,this.W,this.H)}setScale(){this.canvas.style.maxWidth=this.W*this.scale+"px",this.canvas.style.maxHeight=this.H*this.scale+"px",this.canvas.style.width="100%",this.canvas.style.height="100%"}fullScreen(){this.full=!this.full,this.full?(this.canvas.style.maxWidth="",this.canvas.style.maxHeight="",this.canvas.style.width="",this.canvas.style.height="",this.canvas.style.width="100%",this.canvas.style.height="100%"):this.setScale()}getTile(g,h,j){return 0>h||h>this.terrain.layers[g].width-1?!1:0>j||j>this.terrain.layers[g].height-1?!1:("number"!=typeof g&&(g=this.terrain.layers.find(l=>{return l.name===layer_name})),this.terrain.layers[g].data[j][h])}findTile(g,h){let j=this.terrain.layers[g],l=[];for(let m=0;m<j.size.y;m++)for(let o,n=0;n<j.size.x;n++)o=j.geometry[m][n],o===h&&l.push({x:n,y:m});return l}initMap(g){this.terrain=JSON.parse(JSON.stringify(this.maps[g])),this.terrain.layers.forEach(h=>{let j=h.data.map(l=>{return l-1});h.data=Util.array2D(j,h.width)}),this.terrain.tileset=this.terrain.tilesets[0],this.terrain.tileset.image=this.assets.image[this.terrain.tilesets[0].name].image,this.terrain.layers.forEach(h=>{this.terrainCache(h)})}terrainCache(g){g.cache={};let h=g.cache.c=document.createElement("canvas"),j=g.cache.ctx=g.cache.c.getContext("2d");h.width=g.width*this.tile_size,h.height=g.height*this.tile_size,this.drawLayer(j,g)}bitMask(g,h,j){let l=g.data[j][h],m=j-1,n=j+1,o=h-1,p=h+1,q=[0,0,0,0];return-1<m&&l===g.data[m][h]&&(q[0]=1),-1<o&&l===g.data[j][o]&&(q[1]=1),p<g.width&&l===g.data[j][p]&&(q[2]=1),n<g.height&&l===g.data[n][h]&&(q[3]=1),l=1*q[0]+2*q[1]+4*q[2]+8*q[3],l}drawMap(){this.terrain.layers.forEach(g=>{let h=this.current_scene.camera.body.position.x,j=this.current_scene.camera.body.position.y;this.ctx.drawImage(g.cache.c,h,j,this.W,this.H,h,j,this.W,this.H)})}drawLayer(g,h){for(let j=0;j<h.height;j++)for(let m,l=0;l<h.width;l++)if(m=h.data[j][l],!(0>m)){let n=l*this.tile_size,o=j*this.tile_size,p=Math.floor(m%this.terrain.tileset.imagewidth)*this.tile_size,q=Math.floor(m/this.terrain.tileset.imagewidth)*this.tile_size;if(this.terrain.tileset.tileproperties[m]&&"bitmask"===this.terrain.tileset.tileproperties[m].look){let r=this.bitMask(h,l,j);p=Math.floor(r)*this.tile_size,q=this.terrain.tileset.tileproperties[m].line*this.tile_size}g.drawImage(this.terrain.tileset.image,p,q,this.tile_size,this.tile_size,n,o,this.tile_size,this.tile_size)}}};