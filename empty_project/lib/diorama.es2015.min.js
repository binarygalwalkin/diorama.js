var _slicedToArray=function(){function f(g,h){var j=[],l=!0,m=!1,n=void 0;try{for(var p,o=g[Symbol.iterator]();!(l=(p=o.next()).done)&&(j.push(p.value),!(h&&j.length===h));l=!0);}catch(q){m=!0,n=q}finally{try{!l&&o["return"]&&o["return"]()}finally{if(m)throw n}}return j}return function(g,h){if(Array.isArray(g))return g;if(Symbol.iterator in Object(g))return f(g,h);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function f(g,h){for(var l,j=0;j<h.length;j++)l=h[j],l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(g,l.key,l)}return function(g,h,j){return h&&f(g.prototype,h),j&&f(g,j),g}}();function _possibleConstructorReturn(f,g){if(!f)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return g&&("object"==typeof g||"function"==typeof g)?g:f}function _inherits(f,g){if("function"!=typeof g&&null!==g)throw new TypeError("Super expression must either be null or a function, not "+typeof g);f.prototype=Object.create(g&&g.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),g&&(Object.setPrototypeOf?Object.setPrototypeOf(f,g):f.__proto__=g)}function _classCallCheck(f,g){if(!(f instanceof g))throw new TypeError("Cannot call a class as a function")}function Manifest(){var f=this;this.start_scene=void 0,this.size={x:128,y:128},this.background="white",this.scale=1,this.frame_rate=60,this.assets=[],this.maps=[],this.fonts=[],this.boxes=[],this.set={start_screen:function start_screen(g){f.start_scene=g},background:function background(g){f.background=g},scale:function scale(g){f.scale=g},size:function size(g,h){f.size={x:g,y:h}},frame_rate:function frame_rate(g){f.frame_rate=g}},this.add={image:function image(g,h){f.assets.push({type:"img",name:g,path:h})},sound:function sound(g,h){f.assets.push({type:"audio",name:g,path:h})},map:function map(g,h){f.assets.push({type:"map",name:g,path:h})}},this.create={font:function font(g,h,j,l){f.fonts.push({name:g,image:h,size:{x:j,y:l}})},box:function box(g,h,j){f.boxes.push({name:g,image:h,resolution:j})}}}function createManifest(){return new Manifest}var Box=function(){function f(g,h){_classCallCheck(this,f),this.world=g,this.ctx=g.ctx,this.c_ctx=g.c_ctx,this.box_data=h,this.resolution=h.resolution,this.image=g.assets.image[h.image].image}return _createClass(f,[{key:"display",value:function display(g,h,j,l,m){j=Math.max(2*this.resolution,j),l=Math.max(2*this.resolution,l),this.ctx.fillStyle=m||this.world.background_color,this.ctx.fillRect(g+1,h+1,j-2,l-2),this.ctx.lineWidth=2;for(var o=0;4>o;o++){var p=g+Math.floor(o%2)*(j-this.resolution),q=h+Math.floor(o/2)*(l-this.resolution),r=Math.floor(o%2)*(2*this.resolution),s=Math.floor(o/2)*(2*this.resolution);this.ctx.drawImage(this.image,r,s,this.resolution,this.resolution,p,q,this.resolution,this.resolution)}var u=3*this.resolution;this.ctx.drawImage(this.image,8,0,this.resolution,this.resolution,g+8,h,this.resolution+j-u,this.resolution),this.ctx.drawImage(this.image,8,16,this.resolution,this.resolution,g+8,h+l-this.resolution,this.resolution+j-u,this.resolution),this.ctx.drawImage(this.image,0,8,this.resolution,this.resolution,g,h+8,this.resolution,this.resolution+l-u),this.ctx.drawImage(this.image,16,8,this.resolution,this.resolution,g+j-this.resolution,h+this.resolution,this.resolution,this.resolution+l-u)}}]),f}(),Util={};Util.timeStamp=function(){return window.performance.now()},Util.between=function(f,g,h){return 0>(f-g)*(f-h)},Util.random=function(f,g){return f+Math.random()*(g-f)},Util.randomInt=function(f,g){return Math.round(this.random(f,g))},Util.map=function(f,g,h,j,l){return(f-g)/(h-g)*(l-j)+j},Util.lerp=function(f,g,h){return f+(g-f)*h},Util.clamp=function(f,g,h){return Math.max(g,Math.min(h,f))},Util.array2D=function(f,g){for(var h=[],j=0;j<f.length;j+=g)h.push(f.slice(j,j+g));return h},Tween={},Tween.linear=function(f,g,h,j){return h*f/j+g},Tween.easeInOutQuad=function(f,g,h,j){return(f/=j/2,1>f)?h/2*f*f+g:(f--,-h/2*(f*(f-2)-1)+g)},Tween.easeInOutExpo=function(f,g,h,j){return(f/=j/2,1>f)?h/2*Math.pow(2,10*(f-1))+g:(f--,h/2*(-Math.pow(2,-10*f)+2)+g)};var Scene=function(){function f(g){_classCallCheck(this,f),this.name=g,this.loop=!0,this.init_once=!1}return _createClass(f,[{key:"giveWorld",value:function giveWorld(g){this.world=g,this.ctx=g.ctx,this.camera=new Camera(this,0,0)}},{key:"keyDown",value:function keyDown(){}},{key:"keyUp",value:function keyUp(){}},{key:"init",value:function init(){}},{key:"render",value:function render(){}}]),f}(),Vector=function(){function f(g,h){_classCallCheck(this,f),this.x=g||0,this.y=h||0}return _createClass(f,[{key:"set",value:function set(g,h){this.x=g,this.y=h}},{key:"add",value:function add(g){this.x+=g.x,this.y+=g.y}},{key:"sub",value:function sub(g){this.x-=g.x,this.y-=g.y}},{key:"mult",value:function mult(g){this.x*=g,this.y*=g}},{key:"div",value:function div(g){this.x/=g,this.y/=g}},{key:"dot",value:function dot(g){return g.x*this.x+g.y*this.y}},{key:"limit",value:function limit(g){this.mag()>g&&this.setMag(g)}},{key:"mag",value:function mag(){return Math.hypot(this.x,this.y)}},{key:"setMag",value:function setMag(g){0<this.mag()?this.normalize():(this.x=1,this.y=0),this.mult(g)}},{key:"normalize",value:function normalize(){var g=this.mag();0<g&&(this.x/=g,this.y/=g)}},{key:"heading",value:function heading(){return Math.atan2(this.x,this.y)}},{key:"setHeading",value:function setHeading(g){var h=this.mag();this.x=Math.cos(g)*h,this.y=Math.sin(g)*h}},{key:"dist",value:function dist(g){return new f(this.x-g.x,this.y-g.y).mag()}},{key:"angleBetween",value:function angleBetween(g){return Math.atan2(g.y-this.y,g.x-this.x)}},{key:"copy",value:function copy(){return new f(this.x,this.y)}},{key:"fromAngle",value:function fromAngle(g){var h=Math.cos(g),j=Math.sin(g);return new f(h,j)}}]),f}(),Entity=function(){function f(g,h,j){_classCallCheck(this,f),this.scene=g,this.world=g.world,this.ctx=this.world.ctx,this.body=new Body(this,h,j)}return _createClass(f,[{key:"setSprite",value:function setSprite(g){this.sprite=new Sprite(this,g)}},{key:"display",value:function display(){(void 0===this.sprite||!0===this.world.debug)&&(this.ctx.lineWidth=1,this.ctx.strokeStyle="#000",this.ctx.strokeRect(this.body.position.x-0.5,this.body.position.y-0.5,this.body.size.x,this.body.size.y)),void 0!==this.sprite&&this.sprite.display(this.body.position.x,this.body.position.y)}}]),f}(),Sprite=function(){function f(g,h){_classCallCheck(this,f),this.entity=g,this.world=this.entity.world,this.tile_size=this.world.tile_size,this.ctx=this.world.ctx,this.image=this.world.assets.image[h.image].image,this.size=h.size,this.current_frame=0,this.animations={},this.current_animation=void 0,this.width=this.image.width/this.size.x,this.height=this.image.height/this.size.y,this.tick=0,this.speed=0.2,this.offset={x:0,y:0},this.setOffset(0.5,0.5),this.addAnimation("none",[0])}return _createClass(f,[{key:"setOffset",value:function setOffset(g,h){this.offset.x=g,this.offset.y=h}},{key:"addAnimation",value:function addAnimation(g,h){this.animations[g]=h,this.current_animation=g}},{key:"animate",value:function animate(g){this.current_animation=g,1>this.tick?this.tick+=this.speed:(this.tick=0,this.current_frame<this.animations[g].length-1?this.current_frame+=1:this.current_frame=0)}},{key:"display",value:function display(g,h){this.ctx.drawImage(this.image,Math.floor(this.animations[this.current_animation][this.current_frame]%this.width)*this.size.x,Math.floor(this.animations[this.current_animation][this.current_frame]/this.width)*this.size.y,this.size.x,this.size.y,g-this.size.x/2+this.offset.x*this.entity.body.size.x,h-this.size.y/2+this.offset.y*this.entity.body.size.y,this.size.x,this.size.y)}}]),f}(),Body=function(){function f(g,h,j){_classCallCheck(this,f),this.world=g.world,this.step=this.world.FPS.step,this.position=new Vector(h,j),this.next_position=new Vector(h,j),this.velocity=new Vector(0,0),this.stepped_velocity=new Vector(0,0),this.acceleration=new Vector(0,0),this.drag=0.98,this.bounciness=0.2,this.size={x:this.world.tile_size,y:this.world.tile_size},this.half={x:this.size.x/2,y:this.size.y/2},this.collision={left:!1,top:!1,right:!1,bottom:!1}}return _createClass(f,[{key:"setSize",value:function setSize(g,h){this.size.x=g,this.size.y=h,this.half={x:this.size.x/2,y:this.size.y/2}}},{key:"updateVelocity",value:function updateVelocity(){this.velocity.add(this.acceleration),this.velocity.mult(this.drag),this.stepped_velocity=this.velocity.copy(),this.stepped_velocity.mult(this.step),this.next_position=this.position.copy(),this.next_position.add(this.stepped_velocity),this.acceleration.mult(0)}},{key:"updatePosition",value:function updatePosition(){this.position.add(this.stepped_velocity)}},{key:"integration",value:function integration(){this.updateVelocity(),this.updatePosition()}},{key:"applyForce",value:function applyForce(g){this.acceleration.add(g)}},{key:"getTileCollisionData",value:function getTileCollisionData(g,h){var n=this,j={x:Math.floor(g/this.world.tile_size),y:Math.floor(h/this.world.tile_size)},l=this.world.getTile(1,j.x,j.y);if(void 0!==this.world.terrain.tileset.tileproperties[l]&&!0===this.world.terrain.tileset.tileproperties[l].collision){var m=[{x:j.x-1,y:j.y},{x:j.x+1,y:j.y},{x:j.x,y:j.y-1},{x:j.x,y:j.y+1}].map(function(o){var p=n.world.getTile(1,o.x,o.y);return void 0!==n.world.terrain.tileset.tileproperties[p]&&!0===n.world.terrain.tileset.tileproperties[p].collision});return{position:j,neighbors:m}}return!1}},{key:"mapCollision",value:function mapCollision(){var g=this.position.x+this.stepped_velocity.x,h=this.position.y+this.stepped_velocity.y,j=this.getTileCollisionData(g,h),l=this.getTileCollisionData(g+this.size.x,h),m=this.getTileCollisionData(g,h+this.size.y),n=this.getTileCollisionData(g+this.size.x,h+this.size.y);this.collision.left=!1,this.collision.top=!1,this.collision.right=!1,this.collision.bottom=!1,j&&this.AABB(j),l&&this.AABB(l),m&&this.AABB(m),n&&this.AABB(n)}},{key:"AABB",value:function AABB(g){g.position.x*=this.world.tile_size,g.position.y*=this.world.tile_size;var h=this.world.tile_size/2,j=Math.abs(this.position.x+this.half.x-(g.position.x+h)),l=Math.abs(this.position.y+this.half.y-(g.position.y+h)),m=j-this.half.x-h,n=l-this.half.y-h;if(0>m||0>n){if(m==n&&(n=-1),0>m&&m>n)if(this.position.x>g.position.x){if(g.neighbors[1])return!1;this.position.x-=m,this.velocity.x*=-this.bounciness,this.collision.left=!0}else{if(g.neighbors[0])return!1;this.position.x+=m,this.velocity.x*=-this.bounciness,this.collision.right=!0}if(0>n&&n>m)if(this.position.y>g.position.y){if(g.neighbors[3])return!1;this.position.y-=n,this.velocity.y*=-this.bounciness,this.collision.top=!0}else{if(g.neighbors[2])return!1;this.position.y+=n,this.velocity.y*=-this.bounciness,this.collision.bottom=!0}}}}]),f}(),Camera=function(f){function g(h,j,l){_classCallCheck(this,g);var m=_possibleConstructorReturn(this,(g.__proto__||Object.getPrototypeOf(g)).call(this,h,j,l));return m.target={position:new Vector(m.world.W/2,m.world.H/2),size:{x:0,y:0}},m.boundless=!0,m.bounds={x:m.world.W,y:m.world.H},m.angle=0,m}return _inherits(g,f),_createClass(g,[{key:"setBounds",value:function setBounds(h,j){this.bounds.x=h-this.world.W,this.bounds.y=j-this.world.H}},{key:"setTarget",value:function setTarget(h){this.target=h,this.target={position:h.body.position,size:void 0==h.sprite?h.body.size:h.sprite.size}}},{key:"checkBounds",value:function checkBounds(){return!this.boundless&&void(0>this.body.position.x&&(this.body.position.x=0),0>this.body.position.y&&(this.body.position.y=0),this.body.position.x>this.bounds.x&&(this.body.position.x=this.bounds.x),this.body.position.y>this.bounds.y&&(this.body.position.y=this.bounds.y))}},{key:"update",value:function update(){this.body.position.x=this.target.position.x+this.target.size.x/2-this.world.W/2,this.body.position.y=this.target.position.y+this.target.size.x/2-this.world.H/2,this.checkBounds(),this.world.ctx.translate(this.world.W/2,this.world.H/2),this.world.ctx.rotate(this.angle),this.world.ctx.translate(-this.body.position.x-this.world.W/2,-this.body.position.y-this.world.H/2)}}]),g}(Entity),Diorama=function(){function f(g){_classCallCheck(this,f),this.parameters=g,this.debug=!1,this.background_color=g.background||"#000",this.initCanvas(this.parameters),this.counter=0,this.toLoad=this.parameters.assets.length,this.assets={image:{},audio:{}},this.limit_input=!1,this.keys={},this.scenes={},this.start_screen=g.start_screen||void 0,this.current_scene="",this.currentFont=void 0,this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ?!:',.()<>[]",this.fonts={},this.tile_size=16,this.maps={},this.boxes={},this.FPS={now:0,delta:0,last:Util.timeStamp(),step:1/(this.parameters.frame_rate||60)},this.requestChange={value:!1,action:""},this.main_loop=void 0,this.full=!1,this.audio_muted=!1}return _createClass(f,[{key:"ready",value:function ready(){this.loadAssets(this.parameters.assets)}},{key:"initCanvas",value:function initCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.W=this.canvas.width=this.parameters.size.x||256,this.H=this.canvas.height=this.parameters.size.y||256,this.scale=this.parameters.scale||1,this.full=!1,this.ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("crisp"),document.body.appendChild(this.canvas),this.setScale()}},{key:"loader",value:function loader(){this.clear("#222"),this.counter+=1;var g=20,h=this.W-2*g,j=g,l=this.H-2*g;this.ctx.fillStyle="#111",this.ctx.fillRect(j,l,h,20),this.ctx.fillStyle="#333",this.ctx.fillRect(j,l,this.counter*h/this.toLoad,20),this.ctx.strokeStyle="#000",this.ctx.lineWidth=4,this.ctx.strokeRect(j,l,h,20),this.counter===this.toLoad&&this.launch()}},{key:"loadAssets",value:function loadAssets(g){var h=this;void 0===g&&console.log("Nothing to load"),g.map(function(j){return h.checkAssets(j)})}},{key:"checkAssets",value:function checkAssets(g){var l=this,h=g;switch(g.type){case"img":var j=new Image;j.onload=function(){l.loader()},j.onerror=function(){console.log("can't load Image: "+g.name)},j.src=g.path,h.image=j,this.assets.image[g.name]=h;break;case"audio":var m=new Audio(g.path);m.addEventListener("canplaythrough",this.loader()),m.onerror=function(){console.log("can't load audio: "+g.name)},h.audio=m,this.assets.audio[g.name]=h;break;case"map":fetch(g.path).then(function(n){return 200===n.status?void n.json().then(function(o){l.maps[g.name]=o,l.loader()}):void console.log("Looks like there was a problem. Status Code: "+n.status)}).catch(function(){console.log("can't load map: "+g.name)});break;case void 0:console.log(g.name," doesn't have any type");break;default:console.log(g.name," has a none known type");}}},{key:"launch",value:function launch(){this.eventSetup(),this.initBoxes(this.parameters.boxes),this.initFonts(this.parameters.fonts),this.startScene(this.start_screen)}},{key:"initBoxes",value:function initBoxes(g){var h=this;return void 0!==g&&void g.map(function(j){h.boxes[j.name]=new Box(h,j)})}},{key:"drawBox",value:function drawBox(g,h,j,l,m,n){this.boxes[g].display(h,j,l,m,n)}},{key:"setFont",value:function setFont(g){this.currentFont=g}},{key:"initFonts",value:function initFonts(g){var h=this;return void 0===g&&0<g.length?!1:void(g.map(function(j){return void 0===h.assets.image[j.image]?(console.log("can't load font, "+j.image+" doesn't exist"),!1):void(j.image=h.assets.image[j.image].image,h.fonts[j.name]=j)}),this.currentFont=Object.keys(this.fonts)[0])}},{key:"write",value:function write(g,h,j,l,m){if(void 0===this.currentFont)return console.log("No bitmap_font"),!1;if("string"==typeof l){switch(l){case"center":h-=g.length*this.fonts[this.currentFont].size.x/2;break;case"right":h-=g.length*this.fonts[this.currentFont].size.x;break;default:}this.writeLine(g,h,j,m||0)}else this.writeParagraph(g,h,j,l,m||0)}},{key:"writeParagraph",value:function writeParagraph(g,h,j,l,m){for(var n=0,o=this.fonts[this.currentFont].size.y+5,p=this.fonts[this.currentFont].size.x,q=g.split(" "),r="",s=0;s<q.length;s++){r+=q[s]+" ";var u=0,w=q[s+1],z=r.length*p;w?u=w.length*p:0,z+u>l?(this.writeLine(r,h,j+n,m),n+=o,r=""):this.writeLine(r,h,j+n,m)}}},{key:"writeLine",value:function writeLine(g,h,j,l){for(var m=this.fonts[this.currentFont].size.x,n=this.fonts[this.currentFont].size.y,o=this.fonts[this.currentFont].image,p=0;p<g.length;p++){var q=this.alphabet.indexOf(g.charAt(p)),s=h+p*m;this.ctx.drawImage(o,m*q,l*n,m,n,s,j,m,n)}}},{key:"eventSetup",value:function eventSetup(){var g=this;document.addEventListener("keydown",function(h){return g.keyDown(h)},!1),document.addEventListener("keyup",function(h){return g.keyUp(h)},!1)}},{key:"keyDown",value:function keyDown(g){this.limit_input&&g.preventDefault(),this.keys[g.key.toLowerCase()]=!0,this.current_scene.keyDown(g)}},{key:"keyUp",value:function keyUp(g){this.keys[g.key.toLowerCase()]=!1,this.current_scene.keyDown(g)}},{key:"startScene",value:function startScene(g){return 0==Object.keys(game.scenes).length?(console.warn("Sorry, Your project doesn't have any scenes"),!1):(void 0==g&&(g=Object.keys(game.scenes)[0]),void 0===this.scenes[g]?(console.warn("Sorry, the scene named '"+g+"' doesn't exist"),!1):void 0===this.main_loop?void(this.requestChange.value=!1,this.requestChange.action="",this.FPS.last=Util.timeStamp(),this.current_scene=this.scenes[g],this.initScene(),!0===this.current_scene.loop?this.gameLoop():this.mainRender()):(this.requestChange.value=!0,this.requestChange.action=g,!1))}},{key:"initScene",value:function initScene(){return!this.current_scene.init_once&&void this.current_scene.init()}},{key:"addScene",value:function addScene(g){g.giveWorld(this),this.scenes[g.name]=g}},{key:"mainRender",value:function mainRender(){this.clear(),this.ctx.save(),this.current_scene.camera.update(),this.current_scene.render(),this.ctx.restore()}},{key:"loopCheck",value:function loopCheck(){var g=this;!1===this.requestChange.value?this.main_loop=requestAnimationFrame(function(){return g.gameLoop()}):(cancelAnimationFrame(this.main_loop),this.main_loop=void 0,this.startScene(this.requestChange.action))}},{key:"gameLoop",value:function gameLoop(){for(this.FPS.now=Util.timeStamp(),this.FPS.delta+=Math.min(1,(this.FPS.now-this.FPS.last)/1e3);this.FPS.delta>this.FPS.step;)this.FPS.delta-=this.FPS.step,this.mainRender();this.FPS.last=this.FPS.now,this.loopCheck()}},{key:"soundLevel",value:function soundLevel(g){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var j,h=Object.entries(this.assets.audio)[Symbol.iterator]();!(_iteratorNormalCompletion=(j=h.next()).done);_iteratorNormalCompletion=!0){var _step$value=_slicedToArray(j.value,2),l=_step$value[0],m=_step$value[1];m.audio.volume=g}}catch(l){_didIteratorError=!0,_iteratorError=l}finally{try{!_iteratorNormalCompletion&&h.return&&h.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"mute",value:function mute(){this.audio_muted=!this.audio_muted;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var h,g=Object.entries(this.assets.audio)[Symbol.iterator]();!(_iteratorNormalCompletion2=(h=g.next()).done);_iteratorNormalCompletion2=!0){var _step2$value=_slicedToArray(h.value,2),j=_step2$value[0],l=_step2$value[1];l.audio.muted=this.audio_muted}}catch(j){_didIteratorError2=!0,_iteratorError2=j}finally{try{!_iteratorNormalCompletion2&&g.return&&g.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}},{key:"clear",value:function clear(g){this.ctx.fillStyle=g||this.background_color,this.ctx.fillRect(0,0,this.W,this.H)}},{key:"setScale",value:function setScale(){this.canvas.style.maxWidth=this.W*this.scale+"px",this.canvas.style.maxHeight=this.H*this.scale+"px",this.canvas.style.width="100%",this.canvas.style.height="100%"}},{key:"fullScreen",value:function fullScreen(){this.full=!this.full,this.full?(this.canvas.style.maxWidth="",this.canvas.style.maxHeight="",this.canvas.style.width="",this.canvas.style.height="",this.canvas.style.width="100%",this.canvas.style.height="100%"):this.setScale()}},{key:"getTile",value:function getTile(g,h,j){return 0>h||h>this.terrain.layers[g].width-1?!1:0>j||j>this.terrain.layers[g].height-1?!1:("number"!=typeof g&&(g=this.terrain.layers.find(function(l){return l.name===layer_name})),this.terrain.layers[g].data[j][h])}},{key:"findTile",value:function findTile(g,h){for(var j=this.terrain.layers[g],l=[],m=0;m<j.size.y;m++)for(var o,n=0;n<j.size.x;n++)o=j.geometry[m][n],o===h&&l.push({x:n,y:m});return l}},{key:"initMap",value:function initMap(g){var h=this;this.terrain=JSON.parse(JSON.stringify(this.maps[g])),this.terrain.layers.forEach(function(j){var l=j.data.map(function(m){return m-1});j.data=Util.array2D(l,j.width)}),this.terrain.tileset=this.terrain.tilesets[0],this.terrain.tileset.image=this.assets.image[this.terrain.tilesets[0].name].image,this.terrain.layers.forEach(function(j){h.terrainCache(j)})}},{key:"terrainCache",value:function terrainCache(g){g.cache={};var h=g.cache.c=document.createElement("canvas"),j=g.cache.ctx=g.cache.c.getContext("2d");h.width=g.width*this.tile_size,h.height=g.height*this.tile_size,this.drawLayer(j,g)}},{key:"bitMask",value:function bitMask(g,h,j){var l=g.data[j][h],m=j-1,n=j+1,o=h-1,p=h+1,q=[0,0,0,0];return-1<m&&l===g.data[m][h]&&(q[0]=1),-1<o&&l===g.data[j][o]&&(q[1]=1),p<g.width&&l===g.data[j][p]&&(q[2]=1),n<g.height&&l===g.data[n][h]&&(q[3]=1),l=1*q[0]+2*q[1]+4*q[2]+8*q[3],l}},{key:"drawMap",value:function drawMap(){var g=this;this.terrain.layers.forEach(function(h){var j=g.current_scene.camera.body.position.x,l=g.current_scene.camera.body.position.y;g.ctx.drawImage(h.cache.c,j,l,g.W,g.H,j,l,g.W,g.H)})}},{key:"drawLayer",value:function drawLayer(g,h){for(var j=0;j<h.height;j++)for(var m,l=0;l<h.width;l++)if(m=h.data[j][l],!(0>m)){var n=l*this.tile_size,o=j*this.tile_size,p=Math.floor(m%this.terrain.tileset.imagewidth)*this.tile_size,q=Math.floor(m/this.terrain.tileset.imagewidth)*this.tile_size;if(this.terrain.tileset.tileproperties[m]&&"bitmask"===this.terrain.tileset.tileproperties[m].look){var r=this.bitMask(h,l,j);p=Math.floor(r)*this.tile_size,q=this.terrain.tileset.tileproperties[m].line*this.tile_size}g.drawImage(this.terrain.tileset.image,p,q,this.tile_size,this.tile_size,n,o,this.tile_size,this.tile_size)}}}]),f}();